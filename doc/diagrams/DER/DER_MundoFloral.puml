@startuml DER_MundoFloral
' Estilo Crow's Foot para DER visual
hide circle

entity PRODUCT_TYPE {
  *id : string
  name : string
}

entity PLANT {
  *id : string
  name : string
  type : string <<FK PRODUCT_TYPE.id>>
  basePrice : number
  purchasePrice : number
  stock : number
  image : string
  lastPurchaseDate : date
  purchaseHistory : json[]
  createdAt : date
  updatedAt : date
}

entity PURCHASE_HISTORY {
  price : number
  date : date
  quantity : number
  timestamp : datetime
}

entity MOVEMENT {
  *id : string
  type : enum
  plantId : string <<FK PLANT.id>>
  plantName : string
  quantity : number
  price : number
  total : number
  paymentMethod : string
  paymentMethods : map
  paymentSummary : json
  detail : string
  notes : string
  location : string
  date : datetime
  createdBy : string <<FK USER.uid>>
  createdAt : datetime
  hashPrev : string
  hashSelf : string
}

entity SALE {
  *id : string
  plantId : string <<FK PLANT.id>>
  quantity : number
  salePrice : number
  total : number
  paymentMethod : string
  location : string
  notes : string
  date : datetime
  createdBy : string <<FK USER.uid>>
}


entity USER {
  *uid : string
  email : string
  nombre : string
  apellido : string
  telefono : string
  rol : string
  modules : string[]
  creado : datetime
}

entity USERS_BY_EMAIL {
  *email : string
  nombre : string
  apellido : string
  telefono : string
  rol : string
  modules : string[]
  estado : string
  fechaCreacion : datetime
  fechaModif : datetime
  fechaFin : datetime
  tiempoPrueba : int
  rubroId : string
  paisId : string
  createdAt : datetime
  updatedAt : datetime
  ultimaNota : json
  notas : json[]
}

entity RUBROS {
  *id : string
  nombre : string
}

entity PAISES {
  *id : string
  nombre : string
  codigo : string
}

entity ROLES {
  *id : string
  nombre : string
  permisos : string[]
}

entity PAYMENT_METHOD {
  *id : string
  code : string
  name : string
  icon : string
  color : string
  isActive : boolean
  createdAt : datetime
  updatedAt : datetime
}


' Relaciones
PRODUCT_TYPE ||--o{ PLANT : categoriza
PLANT ||--o{ PURCHASE_HISTORY : historial
PLANT ||--o{ MOVEMENT : movimientos
PLANT ||--o{ SALE : ventas
USER ||--o{ MOVEMENT : "crea (plan)"
USER ||--o{ SALE : "crea (plan)"
PAYMENT_METHOD ||--o{ SALE : "usa (1)"
MOVEMENT ||--o{ SALE : "usa (map)"

' Notas
note right of PLANT
Multiproducto: cada item de venta
se guarda como MOVEMENT separado.
paymentMethods = {code: monto}
Finanzas normaliza totales.
end note

note right of PLANT::purchaseHistory
purchaseHistory embebido (últimas 10).
Futuro: separar si crece.
end note

note right of MOVEMENT
Relación n..m con MOVEMENT
resuelta por mapa embebido,
no colección intermedia.
end note

note right of SALE
Tabla histórica redundante.
Puede consolidarse en MOVEMENT
o eliminarse tras migración.
end note

@enduml
